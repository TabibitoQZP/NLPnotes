# 生成式模型

有GAN, VAE, diffusion等. 一些没有什么名气的就不介绍了, 这里主要介绍列出来的这几个.

## diffusion

经典的模型有概率扩散模型 (DDPM) . 这个的推导仅涉及到基础的概率统计知识, 但其推导过程较为复杂.

这里有个网址做这个事情的

[DDPM](https://wangjia184.github.io/diffusion_model/)

顺便这个JS会调用系统资源, 风扇呜呜的...

然后介绍一下DDPM, 首先是对图片如何加噪声? 首先假设$x_0$为原始信息, $x_t$是在$x_{t-1}$前提下添加噪声获得的. 假设图片为

$$
\left[\begin{array}{cc} 
(0,255,255) & (255,0,0) \\
(0,0,255) & (255,255,255) \\
\end{array}\right]
$$

此时每个通道都映射到$[-1,1]$, 公式为$2x/255-1$, 则所谓的信息$x_{t-1}$如下

$$
\left[\begin{array}{cc} 
(-1,1,1) & (1,-1,-1) \\
(-1,-1,1) & (1,1,1) \\
\end{array}\right]
$$

此时, 生成另一个同尺寸的噪声张量, 其中的每个数$\epsilon$都符合正态分布$N(0,1)$, 可能如下

$$
\left[\begin{array}{cc} 
(1.12, -0.37, -0.20) & (-0.88,  0.63, -1.22) \\
(1.37,  0.65, -0.54) & (-1.76,  0.68, -0.21) \\
\end{array}\right]
$$

此时, 对于其中的每一个元素, 都用如下的式子去更新

$$
x\leftarrow\sqrt{\beta}\epsilon+\sqrt{1-\beta}x
$$

这样我们就根据$x_{t-1}$的信息添加噪声得到了$x_t$, 假设对$t$号信息添加噪声对应为$\beta_t$, 且令$\alpha_t=1-\beta_t$. 则可以把结果写成如下的形式

$$
x_t=\sqrt{\alpha_t}x_{t-1}+\sqrt{1-\alpha_t}\epsilon_{t-1}
$$

广义上, 这里要把$x_t$, $\epsilon_t$都理解为张量, 而$\epsilon_t$中的元素都是通过正态分布$N(0,1)$采样得到. 这样, 我们其实把这个任务就从图像这个狭隘层面剥离开了. 通过正态分布叠加, 可以得到如下公式

$$
x_t=\sqrt{\overline\alpha_t}x_0+\sqrt{1-\overline\alpha_t}\epsilon
$$

其中

$$
\overline\alpha_t=\alpha_t\alpha_{t-1}...\alpha_1
$$

证明方式为使用正态分布的可叠加性, 以及数学归纳法, 把$x_{t-1}$代入到$x_t$的公式里, 这样就行了. 注意的是, $\epsilon_t$与$\epsilon_{t-1}$之间只是两次独立的采样, 二者加权叠加还是正态分布.

上述重要公式都可以写成分布的形式

$$
P(x_t|x_{t-1})=N(\sqrt{\alpha_t}x_{t-1},1-\alpha_t)\\
P(x_t)=N(\sqrt{\overline\alpha_t}x_{t-1},1-\overline\alpha_t)
$$

第二个式子实际上是$P(x_t|x_0)$, 但考虑到$x_0$是固定的, 那也就没有条件概率了.

假设通过加噪声, 最后得到的信息为$x_T$, 那么我们的任务, 就是从$x_T$恢复回$x_0$. 这里其实只能用贝叶斯公式

$$
P(x_{t-1}|x_t)=\frac{P(x_t|x_{t-1})P(x_{t-1})}{P(x_t)}
$$

各个$P$可以由正态分布公式代入, 计算得到$P(x_{t-1}|x_t)$仍然是正态分布. 结果太复杂, 但形式如下

$$
P(x_{t-1}|x_t)=N(mx_t+nx_0,\sigma^2)
$$

其中出现了$x_0$, 但我们就是要预测$x_0$, 因此, 这里把$x_t$关于$x_0$的关系式再代回去, 的到一个类似如下的结果

$$
P(x_{t-1}|x_t)=N(ax_t+b\epsilon+c,\sigma^2)
$$

可以看到, 其中的$\epsilon$是随机的, 这个就是NN需要生成的. 倘若我们构建了这样一个NN, 那么就可以根据输入的$x_t$生成对应的$\epsilon$, 再根据分布函数采样获得$x_{t-1}$. 再将$x_{t-1}$输入NN, 可以的到$x_{t-2}$, 这样不断迭代, 最终会得到$x_0$.

这里还有一个小问题, 就是$x_T$怎么来的, 根据$x_T$关于$x_0$的公式, 可以知道在$T$足够大的时候, $\overline\alpha_T$趋于0, 对应的$1-\overline\alpha_T$接近1, 故此时近似于$x_T=\epsilon$. 故任何一张图片, 经过足够多次迭代, 最终都会变成正态噪声; 而任何一个噪声, 经过足够多次NN迭代, 都会变成图片.